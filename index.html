<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>shadow_caster</title>
    <script type="text/javascript" src="javascript/make_seven.js"></script>
    <script type="text/javascript" src="javascript/ickit.js"></script>
    <script type="text/javascript">
      var ck;
      var on_load = function(){
        ck = new ICKit("stage",FirstScene,{'background-color':'#DAE8F2'});
        ck.draw();
      };
      var FirstScene = ICKit.Scene.extend({
        setup:function(){
          var self = this,
              sc_0,
              lc_0;
          this.mousemove = function(e){
            lc_0.x = e.x;
            lc_0.y = e.y;
            cast_shadows();
            ck.draw();
          };
          var create_shadow_casters = function(){
            sc_0 = new ShadowCaster(120, 70, 20, 40, {'background-color':'#008800'});
            self.add(sc_0);
          };
          create_shadow_casters();
          var create_light_casters = function(){
            lc_0 = new LightCaster(180, 120, {'background-color':'#008888'});
            self.add(lc_0);
          };
          create_light_casters();
          var shadow = new ICKit.DisplayObject(0, 0, {'background-color':'#000000'});
          self.add(shadow);
          var line_0 = new Line({'x':0,'y':0}, {'x':0,'y':0}, '#000000');
          self.add(line_0);
          var line_1 = new Line({'x':0,'y':0}, {'x':0,'y':0}, '#000000');
          self.add(line_1);
          var cast_shadows = function(){
            var faces = [];
            for(var i = 0, l = sc_0.vertices.length; i < l; i++){
              var curr = sc_0.vertices[i];
              var next = sc_0.vertices[(i + 1) % l];
              var vx = curr.x - next.x;
              var vy = curr.y - next.y;
              var lx = lc_0.x - (sc_0.x - curr.x);
              var ly = lc_0.y - (sc_0.y - curr.y);
              var dp = vx * lx + vy * ly;
              faces[i] = dp > 0;
            };
            var shadow_start,
                shadow_end;
            var fl = faces.length - 1;
            for(var i = sc_0.vertices.length - 1, l = 0, v_l = sc_0.vertices.length; i >= l; i--){
              var curr = faces[fl];
              var next = faces[fl - 1 >= 0 ? fl - 1 : faces.length - 1];
              fl--;
              if(curr && !next) shadow_start = i;
              if(!curr && next) shadow_end = i;
            };
            shadow_start = (shadow_start + (sc_0.vertices.length >> 2) - 1) % sc_0.vertices.length;
            shadow_end = (shadow_end + (sc_0.vertices.length >> 2) + 1) % sc_0.vertices.length;
            shadow.vertices = [];
            line_0.vertices[0] = {'x':lc_0.x,'y':lc_0.y};
            line_0.vertices[1] = {'x':sc_0.x + sc_0.vertices[shadow_start].x,'y':sc_0.y + sc_0.vertices[shadow_start].y};
            line_1.vertices[0] = {'x':lc_0.x,'y':lc_0.y};
            line_1.vertices[1] = {'x':sc_0.x + sc_0.vertices[shadow_end].x,'y':sc_0.y + sc_0.vertices[shadow_end].y};
            //for(var i = shadow_end; i >= shadow_start; i--){
            //  shadow.add_vertex({'x':sc_0.x + sc_0.vertices[i].x,'y':sc_0.y + sc_0.vertices[i].y});
            //};
            //
          };
          cast_shadows();
        }
      });
      var ShadowCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, width, height, style){
          this.base(x, y, style);
          //this.is_rectangle(width, height);
          this.is_polygon(width, 20, 0)
        }
      });
      var LightCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, style){
          this.base(x, y, style);
          this.is_polygon(5, 10, 0);
        }
      });
      var Line = ICKit.DisplayObject.extend({
        constructor:function(start_point, end_point, color){
          this.base(start_point.x, start_point.y, {'border-width':1,'border-color':color,'background-color':color});
          this.add_vertex({'x':0,'y':0});
          this.add_vertex({'x':end_point.x - start_point.x,'y':end_point.y - start_point.y});
          var self = this;
          this.extend({
            'update_end':function(new_point){
              this.vertices[1] = {'x':new_point.x - self.x, 'y':new_point.y - self.y};
            }
          });
        }
      });
    </script>
    <style type="text/css">
      #stage { width:280px; height:180px; margin:0 auto; }
    </style>
  </head>
  <body onload="on_load()">
    <div id="stage">
    </div>
  </body>
</html>