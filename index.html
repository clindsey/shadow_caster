<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=500;initial-scale=1.0;maximum-scale=1.0;user-scalable=0;">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>shadow_caster</title>
    <script type="text/javascript" src="javascript/excanvas.js"></script>
    <script type="text/javascript" src="javascript/make_seven.js"></script>
    <script type="text/javascript" src="javascript/ickit.js"></script>
    <script type="text/javascript">
      var ck,
          timer,
          stage_offset,
          ie = MakeSeven.fn.is_ie();
      var on_load = function(){
        stage_offset = MakeSeven('#stage').offset();
        ck = new ICKit('stage',FirstScene,{'background-color':'#333333'});
        ck.draw();
        timer = setInterval(function(){
          ck.draw();
        },1000/33);
      };
      var FirstScene = ICKit.Scene.extend({
        setup:function(){
          var shadow_casters = [
              new ShadowCaster(220, 210, 20, 3, {'background-color':'#660000'}),
              new ShadowCaster(120, 250, 12, 6, {'background-color':'#660000'}),
              new ShadowCaster(380, 310, 20, 13, {'background-color':'#660000'}),
              new ShadowCaster(280, 110, 20, 5, {'background-color':'#660000'}),
              new ShadowCaster(580, 90, 10, 13, {'background-color':'#660000'})
            ];
          var self = this;
          var light_caster = new LightCaster(10, 10, {'background-color':'#FFFF44'});
          MakeSeven(light_caster.glows).each(function(){
            self.add(this);
          })
          this.add(light_caster);
          MakeSeven(shadow_casters).each(function(){
            self.add(this.shadow);
          });
          MakeSeven(shadow_casters).each(function(){
            self.add(this);
          });
          MakeSeven(shadow_casters).each(function(){
            cast_shadows(this, light_caster);
          });
          var draw_all_shadows = function(){
            MakeSeven(shadow_casters).each(function(){
              cast_shadows(this, light_caster);
            });
          };
          MakeSeven("#stage").bind('mousemove',function(e){
            var pos = get_x_y(e);
            light_caster.x = pos.x;
            light_caster.y = pos.y;
            draw_all_shadows();
          });
          MakeSeven("#stage").bind('touchstart',function(e){
            move_light(light_caster, e);
            draw_all_shadows();
          });
          MakeSeven("#stage").bind('touchmove',function(e){
            move_light(light_caster, e);
            draw_all_shadows();
          });
        }
      });
      var ShadowCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, radius, edge_count, style){
          this.base(x, y, style);
          this.is_polygon(radius, edge_count, 0);
          this.shadow = new Shadow(this, {'background-color':'#222222'});
        }
      });
      var LightCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, style){
          this.base(x, y, style);
          this.is_polygon(5, 10, 0);
          this.glows = [
              new Glow(this, this.radius * 24, 40, {'background-color':'rgba(255,255,0,0.02)'}),
              new Glow(this, this.radius * 16, 28, {'background-color':'rgba(255,255,0,0.05)'}),
              new Glow(this, this.radius * 10, 22, {'background-color':'rgba(255,255,0,0.1)'})
            ];
        }
      });
      var Shadow = ICKit.DisplayObject.extend({
        constructor:function(target, style){
          this.parent = target;
          this.base(0, 0, style);
        }
      });
      var Glow = ICKit.DisplayObject.extend({
        constructor:function(target, radius, edge_count, style){
          this.parent = target;
          this.base(this.parent.x, this.parent.y, style);
          this.is_polygon(radius, edge_count, 0);
        },
        draw:function(graphics){
          this.x = this.parent.x;
          this.y = this.parent.y;
          this.base(graphics);
        }
      });
      var move_light = function(light, e){
        var pos = get_x_y(e.touches[0]);
        light.x = pos.x;
        light.y = pos.y;
        e.preventDefault();
      };
      var get_x_y = function(e){
        if(ie){
          if(document.documentElement && (document.documentElement.scrollLeft || document.documentElement.scrollTop)){
            x = e.clientX + document.documentElement.scrollLeft - stage_offset.left;
            y = e.clientY + document.documentElement.scrollTop - stage_offset.top;
          }else{
            x = e.clientX + document.body.scrollLeft - stage_offset.left;
            y = e.clientY + document.body.scrollTop - stage_offset.top;
          };
        }else{
          x = e.pageX - stage_offset.left - 2;
          y = e.pageY - stage_offset.top - 2;
        };
        return {'x':x,'y':y};
      };
      var cast_shadows = function(shadow_caster, light_caster){
        var project_point = function(point, light){
          var radius = 800;
          var light_to_point,
              projected_point,
              extra_len,
              vector_to_add,
              ltp_len;
          light_to_point = {'x':point.x - light.x,'y':point.y - light.y};
          ltp_len = Math.sqrt((light_to_point.x * light_to_point.x) + (light_to_point.y * light_to_point.y));
          extra_len = Math.abs(radius - ltp_len);
          vector_to_add = {'x':(light_to_point.x / ltp_len) * extra_len,'y':(light_to_point.y / ltp_len) * extra_len};
          projected_point = {'x':point.x + vector_to_add.x,'y':point.y + vector_to_add.y};
          return projected_point;
        };
        var does_edge_cast_shadow = function(start, end, light){
          var dot_product = function(va, vb){
            return (va.x * vb.x + va.y * vb.y);
          };
          var start_to_end = {'x':end.x - start.x,'y':end.y - start.y};
          var normal = {'x':start_to_end.y,'y':0 - start_to_end.x};
          var light_to_start = {'x':start.x - light.x,'y':start.y - light.y};
          return (dot_product(normal, light_to_start) < 0) ? true : false;
        };
        var curr,
            prev,
            prev_index,
            projected_point;
        shadow_caster.shadow.vertices = [];
        for(var i = 0, l = shadow_caster.vertices.length; i < l; i++){
          prev_index = i - 1 >= 0 ? i - 1 : l - 1;
          curr = {'x':shadow_caster.vertices[i].x + shadow_caster.x,'y':shadow_caster.vertices[i].y + shadow_caster.y};
          prev = {'x':shadow_caster.vertices[prev_index].x + shadow_caster.x,'y':shadow_caster.vertices[prev_index].y + shadow_caster.y};
          if(!does_edge_cast_shadow(curr, prev, light_caster)) continue;
          shadow_caster.shadow.add_vertex({'x':curr.x,'y':curr.y});
          projected_point = project_point(curr, light_caster);
          shadow_caster.shadow.add_vertex({'x':projected_point.x,'y':projected_point.y});
          projected_point = project_point(prev, light_caster);
          shadow_caster.shadow.add_vertex({'x':projected_point.x,'y':projected_point.y});
          shadow_caster.shadow.add_vertex({'x':prev.x,'y':prev.y});
        };
      };
    </script>
    <style type="text/css">
      #stage { width:680px; height:380px; margin:0 auto; cursor:none; }
    </style>
  </head>
  <body onload="on_load()">
    <div id="stage">
    </div>
  </body>
</html>