<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>shadow_caster</title>
    <script type="text/javascript" src="javascript/make_seven.js"></script>
    <script type="text/javascript" src="javascript/ickit.js"></script>
    <script type="text/javascript">
      var ck;
      var on_load = function(){
        ck = new ICKit("stage",FirstScene,{'background-color':'#DAE8F2'});
        ck.draw();
      };
      var FirstScene = ICKit.Scene.extend({
        setup:function(){
          var self = this,
              sc_0,
              lc_0;
          this.mousemove = function(e){
            lc_0.x = e.x;
            lc_0.y = e.y;
            cast_shadows();
            ck.draw();
          };
          var create_shadow_casters = function(){
            sc_0 = new ShadowCaster(120, 70, 20, 20, {'background-color':'#008800'});
            self.add(sc_0);
          };
          create_shadow_casters();
          var create_light_casters = function(){
            lc_0 = new LightCaster(180, 120, {'background-color':'#008888'});
            self.add(lc_0);
          };
          create_light_casters();
          var shadow = new ICKit.DisplayObject(0, 0, {'background-color':'#000000'});
          var cast_shadows = function(){
            var faces = [];
            for(var i = 0, l = sc_0.vertices.length; i < l; i++){
              var curr = sc_0.vertices[i];
              var next = sc_0.vertices[(i + 1) % l];
              var vx = curr.x - next.x;
              var vy = curr.y - next.y;
              var lx = (curr.x) - (lc_0.x - sc_0.x);
              var ly = (curr.y) - (lc_0.y - sc_0.y);
              var dp = vx * lx + vy * ly;
              faces[i] = dp > 0;
            };
            var shadow_start,
                shadow_end;
            for(var i = sc_0.vertices.length - 1, l = 0, v_l = sc_0.vertices.length; i >= l; i--){
              var curr = faces[i];
              var next = faces[(i + 1) % v_l];
              if(curr && !next) shadow_start = i;
              else if(!curr && next) shadow_end = i;
            };
            shadow.vertices = [];
            for(var i = shadow_start; i >= shadow_end; i--){
              shadow.add_vertex({'x':sc_0.x + sc_0.vertices[i].x,'y':sc_0.y + sc_0.vertices[i].y});
            };
            self.add(shadow);
          };
          cast_shadows();
        }
      });
      var ShadowCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, width, height, style){
          this.base(x, y, style);
          this.is_rectangle(width, height);
        }
      });
      var LightCaster = ICKit.DisplayObject.extend({
        constructor:function(x, y, style){
          this.base(x, y, style);
          this.is_polygon(5, 10, 0);
        }
      });
    </script>
    <style type="text/css">
      #stage { width:280px; height:180px; margin:0 auto; }
    </style>
  </head>
  <body onload="on_load()">
    <div id="stage">
    </div>
  </body>
</html>